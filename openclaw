#!/usr/bin/env python3
"""
OpenClaw CLI
Command-line interface to control the Emy-FullStack AI Agent System
"""

import argparse
import json
import sys
import os
from urllib.request import urlopen, Request
from urllib.error import URLError, HTTPError

# Default API URL
API_URL = os.getenv("OPENCLAW_API_URL", "http://localhost:8080")
API_KEY = os.getenv("OPENCLAW_API_KEY", "")


def make_request(method: str, endpoint: str, data: dict = None) -> dict:
    """Make HTTP request to the API"""
    url = f"{API_URL}{endpoint}"
    headers = {
        "Content-Type": "application/json",
    }
    if API_KEY:
        headers["X-API-Key"] = API_KEY
    
    body = json.dumps(data).encode() if data else None
    req = Request(url, data=body, headers=headers, method=method)
    
    try:
        with urlopen(req, timeout=60) as response:
            return json.loads(response.read().decode())
    except HTTPError as e:
        error_body = e.read().decode() if e.fp else str(e)
        try:
            return json.loads(error_body)
        except:
            return {"error": error_body, "status_code": e.code}
    except URLError as e:
        return {"error": f"Connection failed: {e.reason}"}
    except Exception as e:
        return {"error": str(e)}


def cmd_health(args):
    """Check system health"""
    result = make_request("GET", "/health")
    print(json.dumps(result, indent=2))


def cmd_status(args):
    """Get detailed system status"""
    result = make_request("GET", "/status")
    print(json.dumps(result, indent=2))


def cmd_agents(args):
    """List all agents"""
    result = make_request("GET", "/agents")
    if "agents" in result:
        print(f"\n{'Name':<20} {'Type':<15} {'Description'}")
        print("-" * 70)
        for agent in result["agents"]:
            print(f"{agent['name']:<20} {agent['type']:<15} {agent['description'][:35]}...")
        print(f"\nTotal: {result.get('count', len(result['agents']))} agents")
    else:
        print(json.dumps(result, indent=2))


def cmd_create_project(args):
    """Create a new project"""
    data = {
        "name": args.name,
        "project_type": args.type,
        "description": args.description or f"A {args.name} application",
        "features": args.features.split(",") if args.features else [],
        "database": args.database,
        "auth_enabled": not args.no_auth,
    }
    
    print(f"Creating project '{args.name}'...")
    result = make_request("POST", "/projects/create", data)
    print(json.dumps(result, indent=2))


def cmd_generate(args):
    """Generate code"""
    data = {
        "generation_type": args.type,
        "name": args.name,
        "description": args.description or "",
        "language": args.language,
    }
    
    print(f"Generating {args.type}: {args.name}...")
    result = make_request("POST", "/generate/code", data)
    
    if "code" in result:
        if args.output:
            with open(args.output, "w") as f:
                f.write(result["code"])
            print(f"Code written to {args.output}")
        else:
            print("\n" + "=" * 60)
            print(result["code"])
            print("=" * 60)
    else:
        print(json.dumps(result, indent=2))


def cmd_command(args):
    """Execute a command"""
    params = {}
    if args.params:
        for param in args.params:
            key, value = param.split("=", 1)
            # Try to parse as JSON
            try:
                params[key] = json.loads(value)
            except:
                params[key] = value
    
    data = {
        "command": args.command,
        "parameters": params,
        "priority": args.priority,
    }
    
    print(f"Executing command: {args.command}")
    result = make_request("POST", "/command", data)
    print(json.dumps(result, indent=2))


def cmd_run_agent(args):
    """Run a specific agent"""
    data = {
        "command": "run_agent",
        "parameters": {
            "agent": args.agent,
            "task": {
                "type": args.task_type,
                "data": json.loads(args.data) if args.data else {},
            }
        },
        "priority": "medium",
    }
    
    print(f"Running agent: {args.agent}")
    result = make_request("POST", "/command", data)
    print(json.dumps(result, indent=2))


def cmd_logs(args):
    """View recent activity (if endpoint exists)"""
    result = make_request("GET", "/status")
    print(json.dumps(result, indent=2))


def main():
    parser = argparse.ArgumentParser(
        description="OpenClaw CLI - Control the Emy-FullStack AI Agent System",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  openclaw health                          Check system health
  openclaw status                          Get detailed status
  openclaw agents                          List all agents
  openclaw create myapp --type fullstack   Create a new fullstack project
  openclaw generate --type flutter_widget --name LoginForm
  openclaw run-agent frontend --task-type build_ui
  openclaw command build_app --param project=myapp
        """
    )
    
    parser.add_argument("--api-url", default=API_URL, help="API URL (default: http://localhost:8080)")
    parser.add_argument("--api-key", default=API_KEY, help="API key for authentication")
    
    subparsers = parser.add_subparsers(dest="cmd", help="Commands")
    
    # Health command
    health_parser = subparsers.add_parser("health", help="Check system health")
    health_parser.set_defaults(func=cmd_health)
    
    # Status command
    status_parser = subparsers.add_parser("status", help="Get detailed system status")
    status_parser.set_defaults(func=cmd_status)
    
    # Agents command
    agents_parser = subparsers.add_parser("agents", help="List all agents")
    agents_parser.set_defaults(func=cmd_agents)
    
    # Create project command
    create_parser = subparsers.add_parser("create", help="Create a new project")
    create_parser.add_argument("name", help="Project name")
    create_parser.add_argument("--type", "-t", default="fullstack",
                               choices=["flutter_mobile", "flutter_web", "flutter_full", "fastapi_backend", "fullstack"],
                               help="Project type")
    create_parser.add_argument("--description", "-d", help="Project description")
    create_parser.add_argument("--features", "-f", help="Comma-separated features")
    create_parser.add_argument("--database", default="postgresql",
                               choices=["postgresql", "mysql", "sqlite", "mongodb"],
                               help="Database type")
    create_parser.add_argument("--no-auth", action="store_true", help="Disable authentication")
    create_parser.set_defaults(func=cmd_create_project)
    
    # Generate command
    gen_parser = subparsers.add_parser("generate", help="Generate code")
    gen_parser.add_argument("--type", "-t", required=True,
                           choices=["flutter_widget", "api_endpoint", "database_model", "test_suite"],
                           help="Generation type")
    gen_parser.add_argument("--name", "-n", required=True, help="Name of the component")
    gen_parser.add_argument("--description", "-d", help="Description")
    gen_parser.add_argument("--language", "-l", default="dart",
                           choices=["dart", "python", "sql"],
                           help="Target language")
    gen_parser.add_argument("--output", "-o", help="Output file path")
    gen_parser.set_defaults(func=cmd_generate)
    
    # Command execution
    cmd_parser = subparsers.add_parser("command", help="Execute a command")
    cmd_parser.add_argument("command", help="Command to execute")
    cmd_parser.add_argument("--param", "-p", dest="params", action="append",
                           help="Parameters in key=value format")
    cmd_parser.add_argument("--priority", default="medium",
                           choices=["critical", "high", "medium", "low", "background"],
                           help="Task priority")
    cmd_parser.set_defaults(func=cmd_command)
    
    # Run agent command
    run_parser = subparsers.add_parser("run-agent", help="Run a specific agent")
    run_parser.add_argument("agent", help="Agent name (frontend, backend, database, etc.)")
    run_parser.add_argument("--task-type", "-t", default="general", help="Task type")
    run_parser.add_argument("--data", "-d", help="Task data as JSON string")
    run_parser.set_defaults(func=cmd_run_agent)
    
    # Logs command
    logs_parser = subparsers.add_parser("logs", help="View recent activity")
    logs_parser.set_defaults(func=cmd_logs)
    
    args = parser.parse_args()
    
    # Update global API settings
    global API_URL, API_KEY
    API_URL = args.api_url
    if args.api_key:
        API_KEY = args.api_key
    
    if not args.cmd:
        parser.print_help()
        sys.exit(1)
    
    args.func(args)


if __name__ == "__main__":
    main()
